name: Appknox CLI Test Automation

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Allows manual trigger

jobs:
  test:
    runs-on: windows-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v3
    
    - name: Set up JDK 21
      uses: actions/setup-java@v3
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven
    
    # - name: Install Appknox CLI
    #   shell: pwsh
    #   run: |
    #     Write-Host "Downloading Appknox CLI..."
    #     $installPath = "$env:USERPROFILE\appknox.exe"
    #     [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
    #     Invoke-WebRequest -Uri "https://github.com/appknox/appknox-go/releases/download/latest/appknox-Windows-x86_64.exe" -OutFile $installPath
        
    #     Write-Host "Adding Appknox CLI to PATH..."
    #     Add-Content -Path $env:GITHUB_PATH -Value "$env:USERPROFILE"
        
    #     Write-Host "Verifying Appknox CLI installation..."
    #     & $installPath --version


    - name: Install Appknox CLI (Windows)
      shell: pwsh
      run: |
          Write-Host "Fetching latest Appknox CLI release URL..."
          $latestRelease = Invoke-RestMethod -Uri "https://api.github.com/repos/appknox/appknox-go/releases/latest"
          $asset = $latestRelease.assets | Where-Object { $_.name -match "Windows-x86_64.exe" }
          if (-not $asset) { throw "Appknox Windows binary not found in latest release assets!" }

          $downloadUrl = $asset.browser_download_url
          $installPath = "$env:USERPROFILE\appknox.exe"

          Write-Host "Downloading from: $downloadUrl"
          Invoke-WebRequest -Uri $downloadUrl -OutFile $installPath
          Write-Host "Adding Appknox CLI to PATH..."
          Add-Content -Path $env:GITHUB_PATH -Value "$env:USERPROFILE"
          Write-Host "Verifying installation..."
          & $installPath --version

    
    - name: Verify Appknox CLI in PATH
      shell: pwsh
      run: |
        Write-Host "Checking if appknox is in PATH..."
        $env:PATH = "$env:USERPROFILE;$env:PATH"
        appknox.exe --version
    
    - name: Run Tests
      shell: pwsh
      run: mvn clean test
      env:
        APPKNOX_API_HOST: ${{ secrets.APPKNOX_HOST }}
        APPKNOX_ACCESS_TOKEN: ${{ secrets.APPKNOX_TOKEN }}
    
    - name: Generate Allure Report
      if: always()
      shell: pwsh
      run: mvn allure:report
    
    - name: Upload Allure Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: allure-results
        path: target/allure-results
        retention-days: 30
    
    - name: Upload Test Reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-reports
        path: |
          target/surefire-reports
          target/site/allure-maven-plugin
        retention-days: 30
    
    - name: Test Summary
      if: always()
      shell: pwsh
      run: |
        Write-Host "## Test Execution Summary" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
        Write-Host "" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
        
        $xmlFiles = Get-ChildItem -Path "target/surefire-reports" -Filter "*.xml" -ErrorAction SilentlyContinue

        if ($xmlFiles) {
          $totalTests = 0
          $failures = 0
          $errors = 0
          $failedTests = @()

          foreach ($file in $xmlFiles) {
            [xml]$xml = Get-Content $file.FullName
            if ($xml.testsuite) {
              $totalTests += [int]$xml.testsuite.tests
              $failures += [int]$xml.testsuite.failures
              $errors += [int]$xml.testsuite.errors

              # Collect failed test names and messages
              foreach ($testcase in $xml.testsuite.testcase) {
                if ($testcase.failure) {
                  $failedTests += "‚ùå $($testcase.name) ‚Äî $($testcase.failure.message)"
                } elseif ($testcase.error) {
                  $failedTests += "üí• $($testcase.name) ‚Äî $($testcase.error.message)"
                }
              }
            }
          }

          # Write summary
          Write-Host "**Test Statistics:**" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          Write-Host "- Total Tests: $totalTests" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          Write-Host "- Passed: $($totalTests - $failures - $errors)" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          Write-Host "- Failed: $failures" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          Write-Host "- Errors: $errors" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          Write-Host "" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append

          if ($failedTests.Count -gt 0) {
            Write-Host "### ‚ùå Failed Test Cases" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
            foreach ($fail in $failedTests) {
              Write-Host "$fail" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
            }
          } else {
            Write-Host "‚úÖ All test cases passed successfully!" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          }

        } else {
          Write-Host "‚ùå Tests failed to generate reports" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
        }
