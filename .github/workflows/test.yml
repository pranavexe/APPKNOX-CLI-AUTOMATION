name: Appknox CLI Test Automation

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  

jobs:
  test:
    runs-on: ubuntu-latest  
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v3
    
    - name: Set up JDK 21
      uses: actions/setup-java@v3
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven
    
    - name: Install Appknox CLI (Linux)
      run: |
        echo "üîΩ Fetching latest Appknox CLI release URL..."
        LATEST_RELEASE=$(curl -s https://api.github.com/repos/appknox/appknox-go/releases/latest | grep "browser_download_url.*Linux-x86_64" | cut -d '"' -f 4)
        
        if [ -z "$LATEST_RELEASE" ]; then
          echo "‚ùå Failed to get latest release URL"
          exit 1
        fi
        
        echo "üì¶ Downloading from: $LATEST_RELEASE"
        curl -L -o appknox "$LATEST_RELEASE"
        
        echo "‚úÖ Making executable..."
        chmod +x appknox
        
        echo "üìÅ Moving to /usr/local/bin..."
        sudo mv appknox /usr/local/bin/
        
        echo "üîç Verifying installation..."
        appknox --version
        
        echo "‚úÖ Appknox CLI installed successfully!"
    
    - name: Verify Appknox CLI in PATH
      run: |
        echo "Checking if appknox is in PATH..."
        which appknox
        appknox --version
        
    - name: Run TestSuite
      run: mvn clean test "-Dtest=com.appknox.tests.TestSuite"
      env:
        export APPKNOX_API_HOST: ${{ secrets.APPKNOX_HOST }}
        export APPKNOX_ACCESS_TOKEN: ${{ secrets.APPKNOX_TOKEN }}
    
    - name: Generate Allure Report
      if: always()
      run: mvn allure:report
    
    - name: Upload Allure Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: allure-results
        path: target/allure-results
        retention-days: 30
    
    - name: Upload Test Reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-reports
        path: |
          target/surefire-reports
          target/site/allure-maven-plugin
        retention-days: 30
    
    - name: Test Summary
      if: always()
      run: |
        echo "# üìä Test Execution Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if ls target/surefire-reports/*.xml 1> /dev/null 2>&1; then
          TOTAL=0
          FAILURES=0
          ERRORS=0
          FAILED_TESTS=""
          
          for file in target/surefire-reports/TEST-*.xml; do
            if [ -f "$file" ]; then
              # Extract test statistics
              TESTS=$(grep -o 'tests="[0-9]*"' "$file" | grep -o '[0-9]*' || echo "0")
              FAIL=$(grep -o 'failures="[0-9]*"' "$file" | grep -o '[0-9]*' || echo "0")
              ERR=$(grep -o 'errors="[0-9]*"' "$file" | grep -o '[0-9]*' || echo "0")
              
              TOTAL=$((TOTAL + TESTS))
              FAILURES=$((FAILURES + FAIL))
              ERRORS=$((ERRORS + ERR))
              
              # Extract failed test details
              if [ "$FAIL" -gt 0 ] || [ "$ERR" -gt 0 ]; then
                FAILED_TESTS="${FAILED_TESTS}\n$(grep -A 5 '<failure\|<error' "$file" | grep -o 'name="[^"]*"' | cut -d'"' -f2 || true)"
              fi
            fi
          done
          
          PASSED=$((TOTAL - FAILURES - ERRORS))
          
          # Status header
          if [ $FAILURES -eq 0 ] && [ $ERRORS -eq 0 ]; then
            echo "## ‚úÖ All Tests Passed!" >> $GITHUB_STEP_SUMMARY
          else
            echo "## ‚ùå Tests Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìà Test Statistics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| ‚úÖ **Passed** | $PASSED |" >> $GITHUB_STEP_SUMMARY
          echo "| ‚ùå **Failed** | $FAILURES |" >> $GITHUB_STEP_SUMMARY
          echo "| ‚ö†Ô∏è **Errors** | $ERRORS |" >> $GITHUB_STEP_SUMMARY
          echo "| üìä **Total** | $TOTAL |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Failed tests details
          if [ $FAILURES -gt 0 ] || [ $ERRORS -gt 0 ]; then
            echo "### ‚ùå Failed Test Cases" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            for file in target/surefire-reports/TEST-*.xml; do
              if [ -f "$file" ]; then
                # Parse XML for failed tests
                grep -A 10 '<testcase' "$file" | grep -B 1 '<failure\|<error' | while IFS= read -r line; do
                  if echo "$line" | grep -q 'testcase'; then
                    TEST_NAME=$(echo "$line" | grep -o 'name="[^"]*"' | cut -d'"' -f2)
                    CLASS_NAME=$(echo "$line" | grep -o 'classname="[^"]*"' | cut -d'"' -f2)
                    if [ ! -z "$TEST_NAME" ]; then
                      echo "- ‚ùå \`${CLASS_NAME}#${TEST_NAME}\`" >> $GITHUB_STEP_SUMMARY
                    fi
                  fi
                done
              fi
            done
            
            echo "" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚úÖ **All test cases passed successfully!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "üìÅ **Download detailed reports from Artifacts section below**" >> $GITHUB_STEP_SUMMARY
          
        else
          echo "## ‚ùå Tests Failed to Generate Reports" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "No test reports found in \`target/surefire-reports/\`" >> $GITHUB_STEP_SUMMARY
        fi
    
    - name: Check Test Results
      if: always()
      run: |
        HAS_FAILURES=false
        
        if ls target/surefire-reports/TEST-*.xml 1> /dev/null 2>&1; then
          for file in target/surefire-reports/TEST-*.xml; do
            FAILURES=$(grep -o 'failures="[0-9]*"' "$file" | grep -o '[0-9]*' || echo "0")
            ERRORS=$(grep -o 'errors="[0-9]*"' "$file" | grep -o '[0-9]*' || echo "0")
            
            if [ "$FAILURES" -gt 0 ] || [ "$ERRORS" -gt 0 ]; then
              HAS_FAILURES=true
              break
            fi
          done
        fi
        
        if [ "$HAS_FAILURES" == "true" ]; then
          echo "‚ùå Tests failed - marking workflow as failed"
          exit 1
        else
          echo "‚úÖ All tests passed - workflow successful"
          exit 0
        fi